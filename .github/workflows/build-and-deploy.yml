name: Build and Deploy to OpenShift

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
  workflow_dispatch:  # Allow manual triggers

env:
  IMAGE_REGISTRY: image-registry.openshift-image-registry.svc:5000
  IMAGE_NAMESPACE: griot-grits-aa488b
  IMAGE_NAME: gng-backend

jobs:
  build-and-push:
    name: Build and Push Image
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Log in to OpenShift
      uses: redhat-actions/oc-login@v1
      with:
        openshift_server_url: ${{ secrets.OPENSHIFT_SERVER }}
        openshift_token: ${{ secrets.OPENSHIFT_TOKEN }}
        insecure_skip_tls_verify: true

    - name: Get OpenShift registry route
      id: registry-route
      run: |
        REGISTRY_ROUTE=$(oc get route default-route -n openshift-image-registry -o jsonpath='{.spec.host}' 2>/dev/null || echo "")
        if [ -z "$REGISTRY_ROUTE" ]; then
          echo "Creating registry route..."
          oc create route reencrypt --service=image-registry -n openshift-image-registry || true
          REGISTRY_ROUTE=$(oc get route default-route -n openshift-image-registry -o jsonpath='{.spec.host}')
        fi
        echo "registry=$REGISTRY_ROUTE" >> $GITHUB_OUTPUT

    - name: Log in to OpenShift Container Registry
      uses: redhat-actions/podman-login@v1
      with:
        registry: ${{ steps.registry-route.outputs.registry }}
        username: ${{ secrets.OPENSHIFT_USER || 'unused' }}
        password: ${{ secrets.OPENSHIFT_TOKEN }}

    - name: Build container image
      id: build-image
      uses: redhat-actions/buildah-build@v2
      with:
        image: ${{ env.IMAGE_NAME }}
        tags: |
          latest
          ${{ github.sha }}
        containerfiles: |
          ./Dockerfile
        context: .

    - name: Push to OpenShift registry
      id: push-image
      uses: redhat-actions/push-to-registry@v2
      with:
        image: ${{ steps.build-image.outputs.image }}
        tags: ${{ steps.build-image.outputs.tags }}
        registry: ${{ steps.registry-route.outputs.registry }}/${{ env.IMAGE_NAMESPACE }}

    - name: Print image URL
      run: |
        echo "Image pushed to:"
        echo "${{ steps.push-image.outputs.registry-path }}"

  deploy:
    name: Deploy to OpenShift
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Log in to OpenShift
      uses: redhat-actions/oc-login@v1
      with:
        openshift_server_url: ${{ secrets.OPENSHIFT_SERVER }}
        openshift_token: ${{ secrets.OPENSHIFT_TOKEN }}
        insecure_skip_tls_verify: true

    - name: Apply Kubernetes manifests
      run: |
        # Apply in order
        oc apply -f deploy/01-configmap.yaml
        # Secret should already exist or be created manually
        oc apply -f deploy/03-deployment.yaml
        oc apply -f deploy/04-service.yaml
        oc apply -f deploy/05-route.yaml

    - name: Wait for rollout
      run: |
        oc rollout status deployment/gng-backend -n ${{ env.IMAGE_NAMESPACE }} --timeout=5m

    - name: Get application URL
      run: |
        APP_URL=$(oc get route gng-backend -n ${{ env.IMAGE_NAMESPACE }} -o jsonpath='{.spec.host}')
        echo "Application deployed to: https://$APP_URL"
